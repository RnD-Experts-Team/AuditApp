import{j as e,H as D,r as l,a as X}from"./app-0-cEbQZf.js";import{A}from"./app-layout-B-Zvyamh.js";import"./app-oXLXr3Y0.js";import"./button-ozQ66l2n.js";import"./index-CNGqGlaO.js";import"./index-C2h5YoHJ.js";import"./index-AaGKiXUI.js";function z(x){const n=x.clipboardData?.items;if(!n)return null;for(const c of n)if(c.type.startsWith("image/")){const f=c.getAsFile();if(!f)return null;const v=c.type==="image/png"?"png":c.type==="image/webp"?"webp":"jpg";return new File([f],`pasted-${Date.now()}.${v}`,{type:c.type})}return null}function Q({auth:x,audit:n,entities:c=[],ratings:f=[],stores:v=[]}){if(!n)return e.jsxs(A,{user:x.user,children:[e.jsx(D,{title:"Edit Camera Form"}),e.jsx("div",{className:"flex flex-1 flex-col gap-4 p-4 pt-0",children:e.jsx("div",{className:"rounded-lg border bg-card p-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})})})]});const[j,F]=l.useState(()=>n.camera_forms?.find(s=>s?.entity?.date_range_type)?.entity?.date_range_type==="weekly"?"weekly":"daily"),[b,T]=l.useState(()=>{const t=n.camera_forms?.find(s=>s?.entity?.report_type)?.entity?.report_type;return t==="main"||t==="secondary"?t:""}),[_,E]=l.useState({}),[S,U]=l.useState(n.store_id?.toString()||""),[k,M]=l.useState(()=>n.date?new Date(n.date).toISOString().split("T")[0]:""),[R,N]=l.useState(!1),[m,C]=l.useState({}),u=l.useMemo(()=>c.filter(t=>{const s=t.date_range_type===j,r=!b||t.report_type===b;return s&&r}),[c,j,b]);l.useEffect(()=>{E(t=>{const s={...t};return u.forEach(r=>{s[r.id]||(s[r.id]={entity_id:r.id,rating_id:null,note:"",image_file:null,image_preview_url:null,existing_image_url:null,remove_image:!1})}),n.camera_forms?.forEach(r=>{const a=r.entity_id;if(!a)return;const i=s[a];s[a]={entity_id:a,rating_id:r.rating_id??null,note:r.note??"",image_file:i?.image_file??null,image_preview_url:i?.image_preview_url??null,existing_image_url:r.image_url??null,remove_image:i?.remove_image??!1}}),s})},[u,n.camera_forms]);const g=l.useMemo(()=>[...u].sort((t,s)=>{const r=t.sort_order??Number.MAX_SAFE_INTEGER,a=s.sort_order??Number.MAX_SAFE_INTEGER;return r!==a?r-a:t.entity_label.localeCompare(s.entity_label)}),[u]),y=l.useMemo(()=>g.reduce((t,s)=>{const r=s.category?.label||"Uncategorized";return t[r]||(t[r]=[]),t[r].push(s),t},{}),[g]),$=l.useMemo(()=>Object.keys(y).sort((s,r)=>{const a=g.find(p=>(p.category?.label||"Uncategorized")===s)?.category,i=g.find(p=>(p.category?.label||"Uncategorized")===r)?.category,o=a?.sort_order??Number.MAX_SAFE_INTEGER,h=i?.sort_order??Number.MAX_SAFE_INTEGER;return o!==h?o-h:s.localeCompare(r)}),[y,g]),d=(t,s,r)=>{E(a=>({...a,[t]:{...a[t]??{entity_id:t,rating_id:null,note:"",image_file:null,image_preview_url:null,existing_image_url:null,remove_image:!1},[s]:r}}))},w=(t,s)=>{const r=_[t];if(r?.image_preview_url&&URL.revokeObjectURL(r.image_preview_url),!s){d(t,"image_file",null),d(t,"image_preview_url",null);return}d(t,"image_file",s),d(t,"image_preview_url",URL.createObjectURL(s)),d(t,"remove_image",!1)},O=(t,s)=>{const r=z(s);r&&(s.preventDefault(),w(t,r))},P=t=>{w(t,null),d(t,"remove_image",!0),d(t,"existing_image_url",null)},B=t=>{t.preventDefault(),N(!0),C({});const s=new FormData;s.append("store_id",S),s.append("date",k),Object.values(_).filter(i=>{const o=i.rating_id!==null,h=i.note&&i.note.trim()!=="",p=!!i.image_file,L=!!i.existing_image_url,G=!!i.remove_image;return o||h||p||L||G}).forEach((i,o)=>{s.append(`entities[${o}][entity_id]`,String(i.entity_id)),i.rating_id!==null&&s.append(`entities[${o}][rating_id]`,String(i.rating_id)),i.note&&s.append(`entities[${o}][note]`,i.note),i.image_file&&s.append(`entities[${o}][image]`,i.image_file),i.remove_image&&s.append(`entities[${o}][remove_image]`,"1")}),X.post(`/camera-forms/${n.id}?_method=PUT`,s,{forceFormData:!0,preserveScroll:!0,onSuccess:()=>N(!1),onError:i=>{C(i),N(!1)}})};return e.jsxs(A,{user:x.user,children:[e.jsx(D,{title:"Edit Camera Form"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 pt-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Edit Camera Form"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Update inspection values and paste images per entity (Ctrl+V)"})]}),e.jsx("a",{href:"/camera-forms",className:"text-sm font-medium text-muted-foreground hover:text-foreground",children:"â† Back"})]}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"rounded-lg border bg-accent/50 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Filter Entities"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Date Range Type"}),e.jsxs("select",{value:j,onChange:t=>F(t.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"weekly",children:"Weekly"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Report Type"}),e.jsxs("select",{value:b,onChange:t=>T(t.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"main",children:"Main"}),e.jsx("option",{value:"secondary",children:"Secondary"})]})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Showing ",u.length," entities"]})]}),e.jsxs("div",{className:"rounded-lg border bg-card p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Basic Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",children:["Store ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{value:S,onChange:t=>U(t.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",required:!0,children:[e.jsx("option",{value:"",children:"Select Store"}),v.map(t=>e.jsx("option",{value:t.id,children:t.store},t.id))]}),m.store_id&&e.jsx("p",{className:"text-sm text-destructive",children:m.store_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",children:["Date ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("input",{type:"date",value:k,onChange:t=>M(t.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",required:!0}),m.date&&e.jsx("p",{className:"text-sm text-destructive",children:m.date})]})]})]}),e.jsx("div",{className:"space-y-4",children:$.map(t=>{const s=y[t];return e.jsxs("div",{className:"rounded-lg border bg-card",children:[e.jsx("div",{className:"border-b bg-muted/50 px-6 py-4",children:e.jsx("h3",{className:"text-lg font-semibold",children:t})}),e.jsx("div",{className:"p-6 space-y-4",children:s.map(r=>{const a=_[r.id];return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4 p-4 rounded-md bg-muted/20",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("label",{className:"text-sm font-medium",children:r.entity_label})}),e.jsx("div",{className:"space-y-1",children:e.jsxs("select",{value:a?.rating_id??"",onChange:i=>d(r.id,"rating_id",i.target.value?Number(i.target.value):null),className:"flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"Select Rating"}),f.map(i=>e.jsx("option",{value:i.id,children:i.label},i.id))]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("input",{type:"text",placeholder:"Note (optional)",value:a?.note??"",onChange:i=>d(r.id,"note",i.target.value),className:"flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"})}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{onPaste:i=>O(r.id,i),className:"rounded-md border border-dashed bg-background p-3",tabIndex:0,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Click here then"," ",e.jsx("span",{className:"font-semibold",children:"Ctrl+V"})," to paste an image, or choose a file:"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:i=>w(r.id,i.target.files?.[0]??null),className:"block w-full text-xs"}),(a?.image_preview_url||a?.existing_image_url)&&e.jsx("button",{type:"button",onClick:()=>P(r.id),className:"text-xs rounded-md border px-2 py-1 hover:bg-accent",children:"Remove"})]}),a?.image_preview_url&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-muted-foreground mb-1",children:"New image preview:"}),e.jsx("img",{src:a.image_preview_url,alt:"Preview",className:"max-h-32 rounded-md border"})]}),!a?.image_preview_url&&a?.existing_image_url&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-muted-foreground mb-1",children:"Existing image:"}),e.jsx("img",{src:a.existing_image_url,alt:"Existing",className:"max-h-32 rounded-md border"})]})]})})]},r.id)})})]},t)})}),m.entities&&e.jsx("p",{className:"text-sm text-destructive",children:m.entities}),e.jsxs("div",{className:"flex justify-end gap-3 pt-6 border-t",children:[e.jsx("a",{href:"/camera-forms",className:"inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:R,className:"inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow hover:bg-primary/90 disabled:opacity-50",children:R?"Updating...":"Update Form"})]})]})]})]})}export{Q as default};
